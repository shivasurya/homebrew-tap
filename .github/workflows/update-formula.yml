name: Update Formula

on:
  # Triggered by code-pathfinder release
  repository_dispatch:
    types: [new-release]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 0.0.34) - WITHOUT v prefix'
        required: true
        type: string

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Get version (strip v prefix if present)
        id: version
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RAW_VERSION="${{ github.event.client_payload.version }}"
            VERSION="${RAW_VERSION#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Convert 0.0.34 to 0034 for Ruby class name (remove dots)
          CLASS_SUFFIX=$(echo "${VERSION}" | tr -d '.')
          echo "class_suffix=${CLASS_SUFFIX}" >> $GITHUB_OUTPUT

          echo "Processing version: ${VERSION} (class suffix: ${CLASS_SUFFIX})"

      - name: Wait for release assets
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}"

          echo "Waiting for release assets to be available..."
          for i in {1..30}; do
            if curl -sL -o /dev/null -w "%{http_code}" "${BASE_URL}/pathfinder-darwin-arm64.tar.gz" | grep -q "200"; then
              echo "Assets available!"
              break
            fi
            echo "Attempt $i: Assets not ready, waiting 10s..."
            sleep 10
          done

      - name: Download release assets and calculate SHA256
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}"

          echo "Downloading and hashing release assets..."

          # Download and hash each platform
          for platform in darwin-arm64 darwin-amd64 linux-amd64 linux-arm64; do
            ASSET="pathfinder-${platform}.tar.gz"
            echo "Downloading ${ASSET}..."
            curl -sL "${BASE_URL}/${ASSET}" -o "${ASSET}"

            if [ ! -s "${ASSET}" ]; then
              echo "ERROR: Failed to download ${ASSET}"
              exit 1
            fi

            HASH=$(sha256sum "${ASSET}" | cut -d' ' -f1)
            VARNAME=$(echo "${platform}" | tr '-' '_')
            echo "${VARNAME}=${HASH}" >> $GITHUB_OUTPUT
            echo "${platform}: ${HASH}"
            rm "${ASSET}"
          done

          # Get PyPI package SHA256 (latest version)
          echo "Getting PyPI package hash..."
          PYPI_JSON=$(curl -s https://pypi.org/pypi/codepathfinder/json)
          PYPI_URL=$(echo "${PYPI_JSON}" | jq -r '.urls[] | select(.packagetype=="sdist") | .url')
          PYPI_VERSION=$(echo "${PYPI_JSON}" | jq -r '.info.version')

          if [ -z "${PYPI_URL}" ]; then
            echo "ERROR: Could not find PyPI sdist URL"
            exit 1
          fi

          curl -sL "${PYPI_URL}" -o codepathfinder.tar.gz
          PYPI_HASH=$(sha256sum codepathfinder.tar.gz | cut -d' ' -f1)
          echo "pypi=${PYPI_HASH}" >> $GITHUB_OUTPUT
          echo "pypi_url=${PYPI_URL}" >> $GITHUB_OUTPUT
          echo "pypi_version=${PYPI_VERSION}" >> $GITHUB_OUTPUT
          echo "pypi (${PYPI_VERSION}): ${PYPI_HASH}"
          rm codepathfinder.tar.gz

      - name: Update main formula (pathfinder.rb)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FORMULA="Formula/pathfinder.rb"

          echo "Updating main formula to version ${VERSION}..."

          sed -i "s/version \"[^\"]*\"/version \"${VERSION}\"/" "${FORMULA}"
          sed -i "s/sha256 \"[^\"]*\" # darwin-arm64/sha256 \"${{ steps.sha256.outputs.darwin_arm64 }}\" # darwin-arm64/" "${FORMULA}"
          sed -i "s/sha256 \"[^\"]*\" # darwin-amd64/sha256 \"${{ steps.sha256.outputs.darwin_amd64 }}\" # darwin-amd64/" "${FORMULA}"
          sed -i "s/sha256 \"[^\"]*\" # linux-amd64/sha256 \"${{ steps.sha256.outputs.linux_amd64 }}\" # linux-amd64/" "${FORMULA}"
          sed -i "s/sha256 \"[^\"]*\" # linux-arm64/sha256 \"${{ steps.sha256.outputs.linux_arm64 }}\" # linux-arm64/" "${FORMULA}"
          sed -i "s/sha256 \"[^\"]*\" # pypi/sha256 \"${{ steps.sha256.outputs.pypi }}\" # pypi/" "${FORMULA}"

          echo "Main formula updated"

      - name: Create versioned formula (pathfinder@X.Y.Z.rb)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CLASS_SUFFIX="${{ steps.version.outputs.class_suffix }}"
          VERSIONED_FILE="Formula/pathfinder@${VERSION}.rb"

          echo "Creating versioned formula: ${VERSIONED_FILE}"

          cat > "${VERSIONED_FILE}" << EOF
          class PathfinderAT${CLASS_SUFFIX} < Formula
            include Language::Python::Virtualenv

            desc "Open-source security suite with structural code analysis and AI-powered vulnerability detection"
            homepage "https://codepathfinder.dev/"
            license "AGPL-3.0-only"
            version "${VERSION}"

            on_macos do
              on_arm do
                url "https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}/pathfinder-darwin-arm64.tar.gz"
                sha256 "${{ steps.sha256.outputs.darwin_arm64 }}"
              end
              on_intel do
                url "https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}/pathfinder-darwin-amd64.tar.gz"
                sha256 "${{ steps.sha256.outputs.darwin_amd64 }}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}/pathfinder-linux-arm64.tar.gz"
                sha256 "${{ steps.sha256.outputs.linux_arm64 }}"
              end
              on_intel do
                url "https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}/pathfinder-linux-amd64.tar.gz"
                sha256 "${{ steps.sha256.outputs.linux_amd64 }}"
              end
            end

            depends_on "python@3.12"

            resource "codepathfinder" do
              url "${{ steps.sha256.outputs.pypi_url }}"
              sha256 "${{ steps.sha256.outputs.pypi }}"
            end

            keg_only :versioned_formula

            def install
              libexec.install "pathfinder"
              venv = virtualenv_create(libexec/"venv")
              venv.pip_install resource("codepathfinder")
              (bin/"pathfinder").write_env_script(
                libexec/"pathfinder",
                PATH: "#{venv.root}/bin:#{ENV["PATH"]}"
              )
            end

            def caveats
              <<~EOS
                pathfinder@${VERSION} is keg-only (versioned formula).

                To use this version, run:
                  brew unlink pathfinder
                  brew link pathfinder@${VERSION} --force

                Or run directly:
                  \$(brew --prefix)/opt/pathfinder@${VERSION}/bin/pathfinder
              EOS
            end

            test do
              assert_match "Version:", shell_output("#{bin}/pathfinder version")
              system "#{libexec}/venv/bin/python", "-c", "import codepathfinder"
            end
          end
          EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' "${VERSIONED_FILE}"

          echo "Versioned formula created"

      - name: Validate formula syntax
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ruby -c Formula/pathfinder.rb
          ruby -c "Formula/pathfinder@${VERSION}.rb"
          echo "All formula syntax is valid"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update pathfinder to ${{ steps.version.outputs.version }}"
          title: "Update pathfinder to ${{ steps.version.outputs.version }}"
          body: |
            Automated formula update for pathfinder ${{ steps.version.outputs.version }}

            ## Release
            - Version: `${{ steps.version.outputs.version }}`
            - Release URL: https://github.com/shivasurya/code-pathfinder/releases/tag/v${{ steps.version.outputs.version }}

            ## Changes
            - Updated `Formula/pathfinder.rb` (latest version)
            - Created `Formula/pathfinder@${{ steps.version.outputs.version }}.rb` (versioned formula)

            ## Installation
            ```bash
            # Install latest
            brew install shivasurya/tap/pathfinder

            # Install this specific version
            brew install shivasurya/tap/pathfinder@${{ steps.version.outputs.version }}
            ```

            ## SHA256 Checksums
            | Platform | SHA256 |
            |----------|--------|
            | darwin-arm64 | `${{ steps.sha256.outputs.darwin_arm64 }}` |
            | darwin-amd64 | `${{ steps.sha256.outputs.darwin_amd64 }}` |
            | linux-amd64 | `${{ steps.sha256.outputs.linux_amd64 }}` |
            | linux-arm64 | `${{ steps.sha256.outputs.linux_arm64 }}` |
            | PyPI (${{ steps.sha256.outputs.pypi_version }}) | `${{ steps.sha256.outputs.pypi }}` |

            ---
            Automated by [update-formula.yml](https://github.com/shivasurya/homebrew-tap/blob/main/.github/workflows/update-formula.yml)
          branch: update-pathfinder-${{ steps.version.outputs.version }}
          delete-branch: true
          reviewers: shivasurya
